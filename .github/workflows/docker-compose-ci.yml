name: Docker Compose CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  docker-compose:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Create .env file
      run: |
        cat > .env << EOF
        DATABASE_HOST=postgres
        DATABASE_PORT=5432
        DATABASE_USER=postgres
        DATABASE_PASSWORD=postgres
        DATABASE_NAME=product_catalog
        REDIS_HOST=redis
        REDIS_PORT=6379
        REDIS_TTL=600
        BACKEND_PORT=3001
        NODE_ENV=production
        NEXT_PUBLIC_API_URL=http://localhost:3001
        EOF
    
    - name: Build with Docker Compose
      run: docker-compose build
    
    - name: Start services
      run: docker-compose up -d
    
    - name: Wait for services
      run: |
        echo "Waiting for services to be ready..."
        sleep 30
    
    - name: Check services health
      run: |
        docker-compose ps
        docker-compose logs
    
    - name: Test frontend availability
      run: |
        curl -f http://localhost:3000 || exit 1
    
    - name: Test backend availability
      run: |
        curl -f http://localhost:3001/products || exit 1
    
    - name: Stop services
      run: docker-compose down -v
